---
name: Build

on:
  push:
    tags:
    - v[0-9]+.[0-9]+.[0-9]+
    - v[0-9]+.[0-9]+.[0-9]+\-dev

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Code
        uses: actions/checkout@v2-beta
        with:
          ref: ${{ github.ref }}

      - name: Use Python 3.7
        uses: actions/setup-python@v1
        with:
          python-version: 3.7

      - name: Echo github.ref
        run: |
          echo ${{ github.ref }}

      - name: Set env to dev
        if: endsWith(github.ref, 'dev')
        run: |
          echo "::set-env name=ENVIRONMENT::staging"
      - name: Set env to production
        if: endsWith(github.ref, '[0-9]')
        run: |
          echo "::set-env name=ENVIRONMENT::production"

      # - name: Checkout Code
      #   uses: actions/checkout@v2-beta
      #   with:
      #     ref: ${{ github.ref }}

      # - name: Use Python 3.7
      #   uses: actions/setup-python@v1
      #   with:
      #     python-version: 3.7

      # - name: Build project
      #   run: |
      #     echo ${{ github.repository }}
      #     zip -r qgis-plugin-repository.zip .

      # - name: Create Release
      #   id: create_release
      #   uses: actions/create-release@v1.0.0
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: ${{ github.ref }}
      #     release_name: ${{ github.ref }}
      #     body: |
      #       See [${CHANGELOG} ${{ github.ref }}](https://github.com/linz/qgis-plugin-repository/tree/${CHANGELOG}#$(echo ${{ github.ref }} | sed -e 's/[a-zA-Z\.]//g')) for detailed release information.
      #     draft: false
      #     prerelease: false

      # - name: Upload Release Asset
      #   id: upload-release-asset
      #   uses: actions/upload-release-asset@v1.0.1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ./qgis-plugin-repository.zip
      #     asset_name: qgis-plugin-repository
      #     asset_content_type: application/zip

      # - name: Configure AWS Credentials
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ap-southeast-2
      #     role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}

      # - name: Identity Check
      #   run: aws sts get-caller-identity

      # - name: Install npm
      #   uses: actions/setup-node@v1
      #   with:
      #     node-version: '12.x'
      #     registry-url: https://registry.npmjs.org

      # - name: install serverless
      #   run: npm install

      # - name: deploy app
      #   run: npx serverless deploy --stage dev --resource-suffix ${{ secrets.DEPLOYMENT_SUFFIX }}
